{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jose/.gemini/antigravity/scratch/ai-woo-uploader/src/lib/woocommerce.ts"],"sourcesContent":["import WooCommerceRestApi from \"@woocommerce/woocommerce-rest-api\";\r\nimport { Product } from \"./schema\";\r\n\r\nconst api = new WooCommerceRestApi({\r\n    url: process.env.WOOCOMMERCE_URL || \"\",\r\n    consumerKey: process.env.WOOCOMMERCE_CONSUMER_KEY || \"\",\r\n    consumerSecret: process.env.WOOCOMMERCE_CONSUMER_SECRET || \"\",\r\n    version: \"wc/v3\",\r\n});\r\n\r\n/**\r\n * Helper to split a string (comma‑separated or hierarchical using '>') into an array of trimmed strings.\r\n */\r\nconst parseStringArray = (value: unknown): string[] => {\r\n    if (Array.isArray(value)) return value.map(String);\r\n    if (typeof value === \"string\") {\r\n        return value\r\n            .split(\",\")\r\n            .flatMap((part) => part.split(\">\"))\r\n            .map((s) => s.trim())\r\n            .filter((s) => s.length > 0);\r\n    }\r\n    return [];\r\n};\r\n\r\nconst toSlug = (input: string): string => {\r\n    const normalized = input\r\n        .toLowerCase()\r\n        .normalize(\"NFD\")\r\n        .replace(/[\\u0300-\\u036f]/g, \"\")\r\n        .replace(/[^a-z0-9]+/g, \"-\")\r\n        .replace(/^-+|-+$/g, \"\")\r\n        .replace(/-+/g, \"-\");\r\n    return normalized || input.trim().toLowerCase().replace(/\\s+/g, \"-\");\r\n};\r\n\r\nconst ensureTerms = async (endpoint: \"products/categories\" | \"products/tags\", names: string[]): Promise<number[]> => {\r\n    const ids: number[] = [];\r\n    const seen = new Set<string>();\r\n\r\n    for (const originalName of names) {\r\n        const name = originalName.trim();\r\n        if (!name || seen.has(name.toLowerCase())) {\r\n            continue;\r\n        }\r\n        seen.add(name.toLowerCase());\r\n\r\n        const slug = toSlug(name);\r\n\r\n        const findExisting = async () => {\r\n            try {\r\n                const { data } = await api.get(endpoint, { per_page: 50, search: name });\r\n                const match = Array.isArray(data)\r\n                    ? data.find((item: any) => item?.slug === slug || item?.name?.toLowerCase() === name.toLowerCase())\r\n                    : undefined;\r\n                if (match?.id) {\r\n                    return Number(match.id);\r\n                }\r\n            } catch (error) {\r\n                console.error(`WooCommerce API Error fetching ${endpoint}:`, (error as any).response?.data || (error as Error).message);\r\n            }\r\n            return undefined;\r\n        };\r\n\r\n        let termId = await findExisting();\r\n\r\n        if (!termId) {\r\n            try {\r\n                const { data } = await api.post(endpoint, { name, slug });\r\n                if (data?.id) {\r\n                    termId = Number(data.id);\r\n                }\r\n            } catch (error: any) {\r\n                const responseData = error.response?.data;\r\n                const maybeExistingId = responseData?.data?.resource_id;\r\n                if (maybeExistingId) {\r\n                    termId = Number(maybeExistingId);\r\n                } else {\r\n                    // term_exists error when slug already present but search didn't return; try fetching by slug explicitly\r\n                    try {\r\n                        const { data } = await api.get(endpoint, { per_page: 50, slug });\r\n                        if (Array.isArray(data) && data[0]?.id) {\r\n                            termId = Number(data[0].id);\r\n                        }\r\n                    } catch (secondaryError) {\r\n                        console.error(`WooCommerce API Error resolving existing ${endpoint}:`, (secondaryError as any).response?.data || (secondaryError as Error).message);\r\n                    }\r\n\r\n                    if (!termId) {\r\n                        console.error(`WooCommerce API Error creating ${endpoint}:`, responseData || error.message);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        if (termId) {\r\n            ids.push(termId);\r\n        }\r\n    }\r\n\r\n    return ids;\r\n};\r\n\r\n/**\r\n * Validate that an image URL is reachable (HEAD request). Returns true if the request succeeds (status 2xx).\r\n */\r\nconst isImageReachable = async (url: string): Promise<boolean> => {\r\n    try {\r\n        const response = await fetch(url, { method: \"HEAD\" });\r\n        return response.ok;\r\n    } catch {\r\n        return false;\r\n    }\r\n};\r\n\r\nexport async function createProduct(product: Product) {\r\n    const categoriesArray = Array.from(new Set(parseStringArray(product.categories)));\r\n    const tagsArray = Array.from(new Set(parseStringArray(product.tags)));\r\n    const imagesRawArray = parseStringArray(product.images);\r\n\r\n    const [categoryIds, tagIds] = await Promise.all([\r\n        ensureTerms(\"products/categories\", categoriesArray),\r\n        ensureTerms(\"products/tags\", tagsArray),\r\n    ]);\r\n\r\n    // Filter out unreachable images – keep only those that respond with OK.\r\n    const reachableImages = await Promise.all(\r\n        imagesRawArray.map(async (img) => (await isImageReachable(img) ? img : null))\r\n    );\r\n    const imagesArray = reachableImages.filter((i): i is string => i !== null);\r\n\r\n    const manageStock = typeof product.stock_quantity === \"number\";\r\n    const hasDimensions = Boolean(\r\n        product.dimensions &&\r\n        (product.dimensions.length || product.dimensions.width || product.dimensions.height)\r\n    );\r\n\r\n    const data = {\r\n        name: product.name,\r\n        type: product.type || \"simple\",\r\n        status: product.status,\r\n        sku: product.sku,\r\n        regular_price: product.regular_price,\r\n        sale_price: product.sale_price,\r\n        description: product.description,\r\n        short_description: product.short_description,\r\n        categories: categoryIds.length\r\n            ? categoryIds.map((id) => ({ id }))\r\n            : categoriesArray.map((cat) => ({ name: cat })),\r\n        tags: tagIds.length\r\n            ? tagIds.map((id) => ({ id }))\r\n            : tagsArray.map((tag) => ({ name: tag })),\r\n        images: imagesArray.map((img) => ({ src: img })),\r\n        manage_stock: manageStock,\r\n        stock_quantity: manageStock ? product.stock_quantity : undefined,\r\n        weight: product.weight,\r\n        dimensions: hasDimensions\r\n            ? {\r\n                  length: product.dimensions?.length,\r\n                  width: product.dimensions?.width,\r\n                  height: product.dimensions?.height,\r\n              }\r\n            : undefined,\r\n        attributes: product.attributes?.map((attr) => ({\r\n            name: attr.name,\r\n            options: [attr.value],\r\n            visible: attr.visible,\r\n            variation: attr.variation,\r\n        })),\r\n    };\r\n\r\n    try {\r\n        const response = await api.post(\"products\", data);\r\n        return response.data;\r\n    } catch (error: any) {\r\n        console.error(\"WooCommerce API Error:\", error.response?.data || error.message);\r\n        throw new Error(error.response?.data?.message || \"Failed to create product in WooCommerce\");\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 284, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Jose/.gemini/antigravity/scratch/ai-woo-uploader/src/app/api/upload/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { createProduct } from '@/lib/woocommerce';\r\n\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const body = await request.json();\r\n        const { product, images } = body;\r\n\r\n        if (!product) {\r\n            return NextResponse.json({ error: 'Product data is required' }, { status: 400 });\r\n        }\r\n\r\n        // Merge images if provided\r\n        const fullProduct = { ...product, images };\r\n        const result = await createProduct(fullProduct);\r\n        return NextResponse.json({ success: true, product: result });\r\n    } catch (error) {\r\n        console.error('Upload API Error:', error);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACvC,IAAI;QACA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG;QAE5B,IAAI,CAAC,SAAS;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAClF;QAEA,2BAA2B;QAC3B,MAAM,cAAc;YAAE,GAAG,OAAO;YAAE;QAAO;QACzC,MAAM,SAAS,MAAM,IAAA,4IAAa,EAAC;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAO;IAC9D,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}